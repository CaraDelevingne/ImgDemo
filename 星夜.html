<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>星夜Demo</title>
    <link href="css/demo.css" rel="stylesheet"/>
</head>
<body>
    <div id="screen">
        <div id="command">
            <div id="bar"></div>
        </div>
        <div id="common">
            <div id="check">
            	<div class="checked"><a href="梵高风.html"></a></div>
                <p>梵高风</p>
                <div class="checked"><a href="RainPrincess.html"></a></div>
                <p>RainPrincess</p>
                <div class="checked"><a href="抽象风.html"></a></div>
                <p>抽象风</p>
                <div class="checked" style="border: thin solid #fff;"><a href="星夜.html"></a></div>
                <p>星夜</p>
                <div class="checked"><a href="山水画.html"></a></div>
                <p>山水画</p>
                <div class="checked"><a href="工笔花鸟.html"></a></div>
                <p>工笔花鸟</p>
            </div>
        </div>
        <div id="printBox">
            <h3>打印智能绘图</h3>
            <button id="print">打印</button>
        </div>
        <ul id="mask" style="z-index: 999999; width: 100px;">
            <li></li>
            <li></li>
            <li></li>
        </ul>
        <div id="urlInfo"></div>
    </div>
    <input type="hidden" id="hi_selected" value="0" />
    <img id="img_print" />
    <script src="js/jquery-2.js"></script>
    <script src="jqprint/jquery-migrate-1.2.1.min.js" type="text/javascript"></script>
    <script src="jqprint/jquery.jqprint-0.3.js" type="text/javascript"></script>
    <script type="text/javascript">
        var temp = null;
        var my_id = "";
        var m3D = function () {
            /* ---- private vars ---- */
            var diapo = [], imb, scr, bar, selected, urlInfo, camera = { x: 0, y: 0, z: -650, s: 0, fov: 500 }, nw = 0, nh = 0, newSrc, myid,check,btns;
            /* ==== camera tween methods ==== */
            camera.setTarget = function (c0, t1, p) {
                if (Math.abs(t1 - c0) > .1) {
                    camera.s = 1;
                    camera.p = 0;
                    camera.d = t1 - c0;
                    if (p) {
                        camera.d *= 2;
                        camera.p = 9;
                    }
                }
            };
            camera.tween = function (v) {
                if (camera.s != 0) {
                    camera.p += camera.s;
                    camera[v] += camera.d * camera.p * .01;
                    if (camera.p == 10) camera.s = -1;
                    else if (camera.p == 0) camera.s = 0;
                }
                return camera.s;

            };
            /* ==== diapo constructor ==== */
            var Diapo = function (n, img, x, y, z) {
                this.title = img.title;
                this.color = img.color;
                this.isLoaded = false;
                if (document.createElement("canvas").getContext) {
                    /* ---- using canvas in place of images (performance trick) ---- */
                    this.srcImg = new Image();
                    this.srcImg.src = img.src;
                    this.newSrc = img.newsrc;
                    var ca = document.createElement("canvas");
                    ca.id = img.myid;
                    this.img = ca;
                    this.canvas = true;
                    scr.appendChild(this.img);
                }
                /* ---- on click event ---- */
                this.img.onclick = function () {
                    $("#mask").css({ "left": 0, "top": 0, "width": 0 ,"margin-top":0}).hide();
                    $("#hi_selected").val("0");
                    temp = this.diapo;
                    if (camera.s) return;
                    if (this.diapo.isLoaded) {
                        if (this.diapo.urlActive) {
                            /* ---- jump hyperlink ---- */
                            top.location.href = this.diapo.url;
                        } else {
                            /* ---- target positions ---- */
                            camera.tz = this.diapo.z - camera.fov;
                            camera.tx = this.diapo.x;
                            camera.ty = this.diapo.y;
                            /* ---- disable previously selected img ---- */
                            if (selected) {
                                selected.but.className = "button viewed";
                                selected.img.className = "";
                                selected.img.style.cursor = "pointer";
                                selected.urlActive = false;
                                urlInfo.style.visibility = "hidden";
                            }
                            /* ---- select current img ---- */
                            this.diapo.but.className = "button selected";
                            interpolation(false);
                            selected = this.diapo;
                        }
                    }
                };
                /* ---- command bar buttons ---- */
                this.but = document.createElement('div');
                this.but.className = "button";
                bar.appendChild(this.but);
                this.but.diapo = this;
                this.but.style.left = Math.round((this.but.offsetWidth * 1.2) * (n % 4)) + 'px';
                this.but.style.top = Math.round((this.but.offsetHeight * 1.2) * Math.floor(n / 4)) + 'px';
                this.but.onclick = this.img.onclick;
                imb = this.img;
                this.img.diapo = this;
                this.zi = 25000;
                this.img.onclick;
                /* ---- object variables ---- */
                this.x = x;
                this.y = y;
                this.z = z;
                this.css = this.img.style;
                 /* ----- common check buttons ----- */
                //this.btn = document.createElement('div');
                //this.node = document.createElement("p");
                //this.node.className = "textNode";
                //this.btn.className = "checked";
                //check.appendChild(this.btn);
                //check.appendChild(this.node);
                //this.btn.diapo = this;
                //this.btn.style.top = Math.round((this.but.offsetHeight * 7) * Math.floor(n / 1)) + 'px';
            };
            /* ==== main 3D animation ==== */
            Diapo.prototype.anim = function () {
                if (this.isLoaded) {
                    /* ---- 3D to 2D projection ---- */
                    var x = this.x - camera.x;
                    var y = this.y - camera.y;
                    var z = this.z - camera.z;
                    if (z < 20) z += 5000;
                    var p = (camera.fov / z);
                    var w = this.w * p;
                    var h = this.h * p;
                    /* ---- HTML rendering ---- */
                    this.css.left = Math.round(nw + x * p - w * .5) + 'px';
                    this.css.top = Math.round(nh + y * p - h * .5) + 'px';
                    this.css.width = Math.round(w) + 'px';
                    this.css.height = Math.round(h) + 'px';
                    this.css.zIndex = this.zi - Math.round(z);
                } else {
                    /* ---- image is loaded? ---- */
                    this.isLoaded = this.loading();
                }
            };
            /* ==== onload initialization ==== */
            Diapo.prototype.loading = function () {
                if ((this.canvas && this.srcImg.complete) || this.img.complete) {
                    if (this.canvas) {
                        /* ---- canvas version ---- */
                        /*change*/
                        if (my_id !== "") {
                            this.w = this.img.width;
                            this.h = this.img.height;
                            my_id = "";
                        } else {
                            this.w = this.srcImg.width * .55;
                            this.h = this.srcImg.height * .55;
                        }
                        this.img.width = this.w;
                        this.img.height = this.h;
                        var context = this.img.getContext("2d");
                        context.drawImage(this.srcImg, 0, 0, this.w, this.h);
                        console.log("!");
                    } else {
                        /* ---- plain image version ---- */
                        this.w = this.img.width;
                        this.h = this.img.height;
                    }
                    /* ---- button loaded ---- */
                    this.but.className += " loaded";
                    return true;
                }

                return false;
            };
            ////////////////////////////////////////////////////////////////////////////
            /* ==== screen dimensions ==== */
            var resize = function () {
                nw = scr.offsetWidth * .5;
                nh = scr.offsetHeight * .5;
            };
            /* ==== disable interpolation during animation ==== */
            var interpolation = function (bicubic) {
                var i = 0, o;
                while (o = diapo[i++]) {
                    if (o.but) {
                        o.css.msInterpolationMode = bicubic ? 'bicubic' : 'nearest-neighbor'; // makes IE8 happy
                        o.css.imageRendering = bicubic ? 'optimizeQuality' : 'optimizeSpeed'; // does not really work...
                    }
                }
            };
            /* ==== init script ==== */
            var init = function (data) {
                /* ---- containers ---- */
                scr = document.getElementById("screen");
                bar = document.getElementById("bar");
                urlInfo = document.getElementById("urlInfo");
                check = document.getElementById("check");
                resize();
                /* ---- loading images ---- */
                var i = 0, o, n = data.length;
                while (o = data[i++]) {
                    /* ---- images ---- */
                    var x = 1000 * ((i % 4) - 1.5);
                    var y = Math.round(Math.random() * 4000) - 2000;
                    var z = i * (5000 / n);
                    diapo.push(new Diapo(i - 1, o, x, y, z));
                }
                /* ---- start engine ---- */
                run();
            };
            var MyEnd = function () {
                my_id = selected.img.id;
                my_width = selected.css.width;
                my_height = selected.css.height;
                my_left = selected.css.left;
                my_top = selected.css.top;
                my_index = selected.css.zIndex;
                selected.srcImg = new Image();
                selected.srcImg.src = selected.newSrc;
                my_img = selected.img;
                selected.isLoaded = false;
            };
            ////////////////////////////////////////////////////////////////////////////
            /* ==== main loop ==== */
            var run = function () {
                /* ---- x axis move ---- */
                if (camera.tx) {
                    if (!camera.s) camera.setTarget(camera.x, camera.tx);
                    var m = camera.tween('x');
                    if (!m) camera.tx = 0;
                    /* ---- y axis move ---- */
                } else if (camera.ty) {
                    if (!camera.s) camera.setTarget(camera.y, camera.ty);
                    var m = camera.tween('y');
                    if (!m) camera.ty = 0;
                    /* ---- z axis move ---- */
                } else if (camera.tz) {
                    if (!camera.s) camera.setTarget(camera.z, camera.tz);
                    var m = camera.tween('z');
                    if (!m) {
                        /* ---- animation end ---- */
                        camera.tz = 0;
                        interpolation(true);
                        /* ---- activate hyperlink ---- */
                        if (selected.url) {
                            selected.img.style.cursor = "pointer";
                            selected.urlActive = true;
                            selected.img.className = "href";
                            urlInfo.diapo = selected;
                            urlInfo.onclick = selected.img.onclick;
                            urlInfo.innerHTML = selected.title || selected.url;
                            urlInfo.style.visibility = "visible";
                            urlInfo.style.color = selected.color || "#fff";
                            urlInfo.style.top = Math.round(selected.img.offsetTop + selected.img.offsetHeight - urlInfo.offsetHeight - 5) + "px";
                            urlInfo.style.left = Math.round(selected.img.offsetLeft + selected.img.offsetWidth - urlInfo.offsetWidth - 5) + "px";
                        } else {
                            $("#mask").css({ "left": temp.img.offsetLeft, "top": temp.img.offsetTop, "width": temp.img.width }).show();
                            $("#hi_selected").val("1");
                        }
                    }

                }
                /* ---- anim images ---- */
                var i = 0, o;
                while (o = diapo[i++]) o.anim();

                /* ---- loop ---- */
                setTimeout(run, 32);
            };
            return {
                ////////////////////////////////////////////////////////////////////////////
                /* ==== initialize script ==== */
                init: init,
                MyEnd: MyEnd
            }
        }();
        $(function () {
            $("#print").click(function () {
                if (temp == null) {
                    alert("请选择需要打印的图片");
                    return;
                } else {
                    $("#img_print").attr("src", temp.srcImg.src);
                    $("#img_print").jqprint({
                        debug: false, //如果是true则可以显示iframe查看效果（iframe默认高和宽都很小，可以再源码中调大），默认是false
                        importCSS: true, //true表示引进原来的页面的css，默认是true。（如果是true，先会找$("link[media=print]")，若没有会去找$("link")中的css文件）
                        printContainer: true, //表示如果原来选择的对象必须被纳入打印（注意：设置为false可能会打破你的CSS规则）。
                        operaSupport: true//表示如果插件也必须支持歌opera浏览器，在这种情况下，它提供了建立一个临时的打印选项卡。默认是true
                    });
                }
            });
            m3D.init([
               { myid: "Ca_8", src: "images/09.jpg", newsrc: "newImages/09.jpg", title: "All the tools were in place" },
                { myid: "Ca_9", src: "images/47.jpg", newsrc: "newImages/47.jpg", title: "All the tools were in place" },
                { myid: "Ca_10", src: "images/85.jpg", newsrc: "newImages/85.jpg", title: "All the tools were in place" },
                { myid: "Ca_11", src: "images/125.jpg", newsrc: "newImages/125.jpg", title: "All the tools were in place" }
            ]);
            setInterval(function () {
                if ($("#hi_selected").val() === "1") {
                    var topvalue = parseInt($("#mask").css("margin-top"));
                    if (topvalue <= temp.img.height-50) {
                        $("#mask").css("margin-top", parseInt($("#mask").css("margin-top")) + 20);
                    } else {
                        m3D.MyEnd();
                        $("#mask").css({ "left": 0, "top": 0, "margin-top": 0 }).hide();
                        $("#hi_selected").val("0");
                    }
                }
            }, 100);

            /* ----- common check buttons onclick ----- */
            $(".checked").click(function() {
                $(this).css({border:"thin solid #fff"}).siblings().css({border:""});

            });

            winHeight();
        });
        $(window).resize(function(){
            winHeight();
        })

         function winHeight(){
                var win = $(window).height();
                $("#common").css("height",win-30)
            }
    </script>
</body>
</html>